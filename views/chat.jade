h1 Chat Page
#chatContainer
    #chat
    #chatControls
        input#chatMsg(type="text", name="chatMsg", value="")
        input#chatSend(type="submit", value="Enter")
    #log
script(type="text/javascript", src="/socket.io/socket.io.js")
script(type="text/javascript")
    function printLog(msg) {
        $("#log").append(msg);
        var logWin = document.getElementById("log");
        var scrollHeight = Math.max(logWin.scrollHeight, logWin.clientHeight);
        logWin.scrollTop = scrollHeight + 100;
    }

    function printChat(msg) {
        $("#chat").append(msg);
        var chatWin = document.getElementById("chat");
        var scrollHeight = Math.max(chatWin.scrollHeight, chatWin.clientHeight);
        chatWin.scrollTop = scrollHeight + 100;
    }

    var STATES = {
            "CONNECTED": 0,
            "LOGGEDIN": 1,
            "JOINED": 2,
            "DISCONNECTED": 3
    };
    var client = {
        uid: "#{uid}",
        conn: new io.Socket("serialx.net"),
        state: STATES.CONNECTED
    };

    client.conn.connect();

    client.conn.on('connect', function() {
        printLog("<p>Connected</p>");
        client.conn.send('UID ' + client.uid);
        printLog("<p>Sent UID: " + "#{uid}" + "</p>");
    });

    client.conn.on('message', function(data) {
        var res, code, msg;
        var parsed = data.split(" ");
        printLog("<p>Message from server: " + data + "</p>");

        res = parsed[0];
        code = parsed[1];
        msg = parsed[2];

        switch (res)
        {
            case "OK":
                switch(code) {
                    case "LOGGEDIN":
                        printLog("<p>Logged in!</p>");
                        client.state = STATES.LOGGEDIN;
                        client.conn.send('FIND');
                        printLog("<p>Requested room...</p>");
                        break;
                    case "JOINED":
                        printLog("<p>Roomcode received: " + msg + "</p>");
                        client.state = STATES.JOINED;
                        break;
                    case "MSG":
                        printChat('<p><span class="stranger">Stranger</span>' + msg + '</p>');
                        break;
                    default:
                        printLog("<p>No code received from server</p>");
                        break;
                }
                break;
            case "ERROR":
                printLog("<p>Error received from server</p>");
                client.conn.disconnect();
                client.state = STATES.DISCONNECTED;
                break;
            default:
                printLog("<p>Unknown response received from server</p>");
                client.conn.disconnect();
                client.state = STATES.DISCONNECTED;
                break;
        }
    });
    client.conn.on('disconnect', function() {
        printLog("<p>Disconnect</p>");
        client.state = STATES.DISCONNECTED;
    });
script(type="text/javascript")
    $(function() {
        $("#chatMsg").keyup(function(evt) {
            if(event.which == "13") {
                if(client.state == STATES.JOINED) {
                    client.conn.send("MSG " + $("#chatMsg").val());
                    printChat('<p><span class="you">You</span>' + $("#chatMsg").val() + '</p>');
                    $(this).val("");
                } else {
                    printChat('<p><span class="system">System</span>Finding your chat mate. Please wait!</p>');
                }
            }
        });
        $("#chatSend").click(function(evt) {
            if(client.state == STATES.JOINED) {
                client.conn.send("MSG " + $("#chatMsg").val());
                printChat('<p><span class="you">You</span>' + $("#chatMsg").val() + '</p>');
                $(this).val("");
            } else {
                printChat('<p><span class="system">System</span>Finding your chat mate. Please wait!</p>');
            }
        });
    });
